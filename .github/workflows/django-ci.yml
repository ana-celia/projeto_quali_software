name: Django CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  duplicate-check:
    name: "ðŸ” Detector de CÃ³digo Duplicado"
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Instalar radon
      run: pip install radon

    - name: Verificar duplicaÃ§Ã£o no cÃ³digo real
      run: |
        cd artesanato
        echo "=== DETECTOR DE CÃ“DIGO DUPLICADO ==="
        echo "ðŸ” Analisando: api/"
        radon raw api/ --min D 2>&1 | grep -B1 -A1 "duplicate\|similar" && exit 1 || echo "âœ… NENHUMA DUPLICAÃ‡ÃƒO ENCONTRADA - CÃ³digo limpo!"

  code-smells-check:
    name: "ðŸ‘ƒ Detector de Code Smells"
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Instalar ferramentas de anÃ¡lise
      run: |
        pip install pylint pylint-django radon

    - name: Executar anÃ¡lise de code smells
      run: |
        cd artesanato
        
        echo "ðŸš€ ANALISANDO CODE SMELLS"
        echo "=========================="

        # Configurar Django
        export DJANGO_SETTINGS_MODULE="artesanato.settings"
        export PYTHONPATH="$PWD:$PYTHONPATH"

        # Analisar com Pylint e pegar os 3 mais frequentes
        echo -e "\nðŸ” Buscando os 3 code smells mais frequentes..."

        # Executar Pylint e processar resultados
        pylint --load-plugins pylint_django --output-format=json api/ 2>/dev/null | python3 -c " import json, collections

        try:
            import sys
            data = json.load(sys.stdin)

            if not data:
                print('âœ… Nenhum code smell encontrado!')
                sys.exit(0)

            # Contar frequÃªncia
            counts = collections.Counter(item['symbol'] for item in data)

            print(f'ðŸ“Š Total de code smells: {len(data)}')
            print(f'ðŸ” Tipos diferentes: {len(counts)}')

            # Top 3
            top_3 = counts.most_common(3)

            print('\nðŸ† TOP 3 CODE SMELLS:')
            print('====================')

            for i, (symbol, count) in enumerate(top_3, 1):
                print(f'\n{i}Âº - {symbol} ({count} ocorrÃªncias)')

                # Mostrar primeiro exemplo
                for item in data:
                    if item['symbol'] == symbol:
                        filename = item['path'].split('/')[-1]
                        print(f'   ðŸ“ {filename}:{item[\"line\"]} - {item[\"message\"][:80]}...')
                        break

            print('\nâœ… AnÃ¡lise concluÃ­da')

        except Exception as e:
            print('âŒ Erro na anÃ¡lise:', str(e))
            print('\nExecutando anÃ¡lise simples...')
            import subprocess
            result = subprocess.run(['pylint', '--load-plugins', 'pylint_django', 'api/'], 
                                  capture_output=True, text=True)
            print(result.stdout[:500])
        " || echo "âš ï¸  AnÃ¡lise completa disponÃ­vel nos logs"

                echo -e "\n=========================="
                echo "âœ… ANÃLISE CONCLUÃDA"

  lint:
    name: "ðŸ“ AnÃ¡lise de CÃ³digo"
    runs-on: ubuntu-latest
    needs: code-smells-check

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Instalar dependÃªncias do projeto
      run: |
        cd artesanato
        pip install -r requirements.txt

    - name: Verificar estilo PEP 8 com flake8
      run: |
        cd artesanato
        pip install flake8
        flake8 . --count --statistics

  test:
    name: "ðŸ§ª Testes"
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: 9061
          POSTGRES_DB: artesanato
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Instalar dependÃªncias
      run: |
        cd artesanato
        pip install -r requirements.txt

    - name: Rodar migraÃ§Ãµes
      run: |
        cd artesanato
        python manage.py migrate
      env:
        DATABASE_URL: postgresql://postgres:9061@localhost:5432/artesanato

    - name: Rodar testes
      run: |
        cd artesanato
        python manage.py test
      env:
        DATABASE_URL: postgresql://postgres:9061@localhost:5432/artesanato

    - name: Verificar sintaxe Django
      run: |
        cd artesanato
        python manage.py check

  uml-diagram:
    name: "ðŸ“Š Gerar Diagrama UML"
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Instalar Graphviz
      run: sudo apt-get update && sudo apt-get install -y graphviz

    - name: Instalar dependÃªncias Python
      run: |
        cd artesanato
        pip install -r requirements.txt django-extensions pydotplus

    - name: Gerar diagrama UML
      run: |
        cd artesanato

        # Configurar Django
        export DJANGO_SETTINGS_MODULE="artesanato.settings"
        export PYTHONPATH="$PWD:$PYTHONPATH"

        # Criar diretÃ³rio
        mkdir -p docs

        # Gerar diagrama
        echo "ðŸ“Š Gerando diagrama UML com pydotplus..."
        python manage.py graph_models api \
          --output docs/class_diagram.png \
          --theme django2018 \
          --group-models \
          --arrow-shape normal

        # Verificar se gerou
        if [ -f "docs/class_diagram.png" ]; then
          echo "âœ… Diagrama gerado com sucesso!"
          ls -la docs/class_diagram.png
        else
          echo "âš ï¸  NÃ£o gerou PNG, tentando formato DOT..."
          python manage.py graph_models api --dot > docs/class_diagram.dot
          dot -Tpng docs/class_diagram.dot -o docs/class_diagram.png
        fi

    - name: Upload diagrama
      uses: actions/upload-artifact@v4
      with:
        name: uml-diagram
        path: artesanato/docs/class_diagram.png