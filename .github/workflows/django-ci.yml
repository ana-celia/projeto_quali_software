name: Django CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  duplicate-check:
    name: "üîç Detector de C√≥digo Duplicado"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar radon
        run: pip install radon

      - name: Verificar duplica√ß√£o no c√≥digo real
        run: |
          cd artesanato
          echo "=== DETECTOR DE C√ìDIGO DUPLICADO ==="
          echo "üîç Analisando: api/"
          radon raw api/ --min D 2>&1 | grep -B1 -A1 "duplicate\|similar" && exit 1 || echo "‚úÖ NENHUMA DUPLICA√á√ÉO ENCONTRADA - C√≥digo limpo!"

  lint:
    name: "üìù An√°lise de C√≥digo"
    runs-on: ubuntu-latest
    needs: duplicate-check

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar depend√™ncias do projeto
        run: |
          cd artesanato
          pip install -r requirements.txt

      - name: Verificar estilo PEP 8 com flake8
        run: |
          cd artesanato
          pip install flake8
          flake8 . --count --statistics

  test:
    name: "üß™ Testes"
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: 9061
          POSTGRES_DB: artesanato
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar depend√™ncias
        run: |
          cd artesanato
          pip install -r requirements.txt

      - name: Rodar migra√ß√µes
        run: |
          cd artesanato
          python manage.py migrate
        env:
          DATABASE_URL: postgresql://postgres:9061@localhost:5432/artesanato

      - name: Rodar testes
        run: |
          cd artesanato
          python manage.py test
        env:
          DATABASE_URL: postgresql://postgres:9061@localhost:5432/artesanato

      - name: Verificar sintaxe Django
        run: |
          cd artesanato
          python manage.py check

  uml-diagram:
    name: "üìä Gerar Diagrama UML"
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Instalar depend√™ncias Python
        run: |
          cd artesanato
          pip install -r requirements.txt django-extensions pydotplus

      - name: Gerar diagrama UML
        run: |
          cd artesanato

          # Configurar Django
          export DJANGO_SETTINGS_MODULE="artesanato.settings"
          export PYTHONPATH="$PWD:$PYTHONPATH"

          # Criar diret√≥rio
          mkdir -p docs

          # Gerar diagrama
          echo "üìä Gerando diagrama UML com pydotplus..."
          python manage.py graph_models api \
            --output docs/class_diagram.png \
            --theme django2018 \
            --group-models \
            --arrow-shape normal

          # Verificar se gerou
          if [ -f "docs/class_diagram.png" ]; then
            echo "‚úÖ Diagrama gerado com sucesso!"
            ls -la docs/class_diagram.png
          else
            echo "‚ö†Ô∏è  N√£o gerou PNG, tentando formato DOT..."
            python manage.py graph_models api --dot > docs/class_diagram.dot
            dot -Tpng docs/class_diagram.dot -o docs/class_diagram.png
          fi

      - name: Upload diagrama
        uses: actions/upload-artifact@v4
        with:
          name: uml-diagram
          path: artesanato/docs/class_diagram.png

  code-smells-check:
    name: "üëÉ Detector de Code Smells"
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Instalar ferramentas
      run: |
        cd artesanato
        pip install pylint pylint-django radon
    
    - name: Configurar Django
      run: |
        cd artesanato
        export DJANGO_SETTINGS_MODULE="artesanato.settings"
        export PYTHONPATH="$PWD:$PYTHONPATH"

    - name: Executar an√°lise completa de code smells
      run: |
        cd artesanato
        echo "üöÄ AN√ÅLISE DE CODE SMELLS INICIADA"
        echo "=================================="
        echo -e "\nüîç 1. CODE SMELLS DE DESIGN (R09*):"
        pylint --load-plugins pylint_django --disable=all --enable=R0901,R0902,R0903,R0912,R0913,R0914,R0915 api/ 2>&1 | tail -20 || true
        echo -e "\nüìè 2. PROBLEMAS DE FORMATA√á√ÉO (C03*):"
        pylint --load-plugins pylint_django --disable=all --enable=C0301,C0302,C0303 api/ 2>&1 | tail -10 || true
        echo -e "\nüè∑Ô∏è  3. PROBLEMAS DE NOMENCLATURA (C01*):"
        pylint --load-plugins pylint_django --disable=all --enable=C0103,C0111,C0112 api/ 2>&1 | tail -10 || true
        echo -e "\nüìä 4. ESTAT√çSTICAS GERAIS:"
        pylint --load-plugins pylint_django --output-format=json api/ 2>&1 || true
        echo -e "\nüìà 5. AN√ÅLISE DE COMPLEXIDADE (RADON):"
          radon cc api/ -a 2>&1 || true
        echo -e "\n=================================="
        echo "‚úÖ AN√ÅLISE DE CODE SMELLS CONCLU√çDA"
          
        echo -e "\n=================================="
        echo "‚úÖ AN√ÅLISE DE CODE SMELLS CONCLU√çDA"